<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .price-card {
            margin-bottom: 20px;
        }
        .trend-up {
            color: #dc3545;
        }
        .trend-down {
            color: #198754;
        }
        .news-source {
            font-size: 0.9em;
            color: #6c757d;
        }
        .price-amount {
            font-size: 1.2em;
            font-weight: bold;
        }
        .oil-type {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        .news-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .news-item {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .trend-stranded { color: #888; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">系统</h1>
        
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">信息</h5>
                        <div id="latestPriceInfo" class="mb-4">
                            <!-- 最新油价信息将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">日期</h5>
                        <div id="priceInfo" class="mb-4">
                            <!-- 油价调整日期将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">订阅日历</h5>
                        <p class="card-text">订阅后，您将在每次油价调整时收到日历提醒。</p>
                        <button id="subscribeBtn" class="btn btn-primary">订阅日历</button>
                        <div id="subscribeResult" class="mt-3">
                            <!-- 订阅结果将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取最新油价信息
        async function fetchLatestPriceInfo() {
            try {
                const response = await fetch('/api/dates');
                const data = await response.json();
                const latestInfoDiv = document.getElementById('latestPriceInfo');
                
                const trend = data.manualTrend || data.lastTrend;
const amount = data.manualAmount || data.lastAmount;
const updateTime = data.manualUpdate || data.lastUpdate;
const source = data.manualTrend ? '手动设置' : (data.lastSource || '未知');
const newsUrl = data.manualTrend ? '' : (data.lastNewsUrl || '');

if (updateTime && trend) {
    let trendClass, trendText;
if (trend === 'up') {
    trendClass = 'trend-up';
    trendText = '上涨';
} else if (trend === 'down') {
    trendClass = 'trend-down';
    trendText = '下跌';
} else if (trend === 'stranded') {
    trendClass = 'trend-stranded';
    trendText = '搁浅';
} else {
    trendClass = '';
    trendText = trend || '';
}
    let html = `
        <div class="card">
            <div class="card-body">
                <p class="card-text">调整时间：${updateTime}</p>
                <p class="card-text">调整预期：<span class="${trendClass}">${trendText}</span> ${amount ? `<span class="price-amount">${amount}元</span>` : ''}</p>
                ${newsUrl ? `
                    <p class="card-text mt-3 news-source">
                        来源：${source}
                        <a href="${newsUrl}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                            查看详情
                        </a>
                    </p>
                ` : `<p class="card-text mt-3 news-source">来源：${source}</p>`}
            </div>
        </div>
    `;
    latestInfoDiv.innerHTML = html;
} else {
                    // 查找下一个调整日期
                    let nextDate = null;
                    const now = new Date();
                    if (data.adjustmentDates && data.adjustmentDates.length > 0) {
                        // 排序，找到第一个大于当前时间的日期
                        const sorted = data.adjustmentDates
                            .map(d => {
                                if (d.date.includes('24:00')) {
                                    const [datePart] = d.date.split(' ');
                                    const [year, month, day] = datePart.split('-');
                                    return {raw: d.date, date: new Date(year, month - 1, parseInt(day) + 1, 0, 0, 0)};
                                } else {
                                    return {raw: d.date, date: new Date(d.date)};
                                }
                            })
                            .filter(d => d.date > now)
                            .sort((a, b) => a.date - b.date);
                        if (sorted.length > 0) {
                            nextDate = sorted[0].raw;
                        }
                    }
                    if (nextDate) {
                        latestInfoDiv.innerHTML = `<p class="text-muted">下次调整时间：${nextDate}，待预测</p>`;
                    } else {
                        latestInfoDiv.innerHTML = '<p class="text-muted">暂无未来油价调整日期</p>';
                    }
                }
            } catch (error) {
                console.error('获取最新油价信息失败:', error);
            }
        }

        // 获取油价调整日期
        async function fetchPriceInfo() {
            try {
                const response = await fetch('/api/dates');
                const data = await response.json();
                const priceInfoDiv = document.getElementById('priceInfo');
                
                let html = '<div class="list-group">';
                const now = new Date();
                let hasFutureDates = false;

                // 对 adjustmentDates 进行排序，确保日期是升序的
                data.adjustmentDates.sort((a, b) => new Date(a.date) - new Date(b.date));

                data.adjustmentDates.forEach(dateEntry => {
    // 处理24:00的情况，将其转换为次日的00:00
    let adjustmentDate;
    if (dateEntry.date.includes('24:00')) {
        const [datePart] = dateEntry.date.split(' ');
        const [year, month, day] = datePart.split('-');
        adjustmentDate = new Date(year, month - 1, parseInt(day) + 1, 0, 0, 0);
    } else {
        adjustmentDate = new Date(dateEntry.date);
    }

    if (adjustmentDate > now) { // 只显示未来的日期
        hasFutureDates = true;
        const diffMs = adjustmentDate - new Date(); // 重新获取精确的当前时间，计算准确差值
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        let countdownText = '';
        if (diffHours <= 24) {
            countdownText = `${diffHours}小时后`;
        } else {
            countdownText = `${diffDays}天后`;
        }

        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${dateEntry.date}</h6>
                    <span class="badge bg-primary">${countdownText}</span>
                </div>
            </div>
        `;
    }
});
                html += '</div>';
                
                if (!hasFutureDates) {
                    priceInfoDiv.innerHTML = '<p class="text-muted">暂无未来油价调整日期</p>';
                } else {
                    priceInfoDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('获取油价信息失败:', error);
            }
        }

        // 订阅日历
        document.getElementById('subscribeBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/subscribe', {
                    method: 'POST'
                });
                const data = await response.json();
                
                const resultDiv = document.getElementById('subscribeResult');
                
                // 尝试复制URL到剪贴板
                try {
                    await navigator.clipboard.writeText(window.location.origin + data.calendarUrl);
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <p>订阅链接已成功复制到剪贴板！</p>
                            <p>请按照以下步骤将日历添加到您的日历应用：</p>
                            <ul>
                                <li><strong>Google 日历:</strong> 打开Google日历 -> 左侧"其他日历"旁边点击"+" -> 选择"通过网址" -> 粘贴链接并点击"添加日历"。</li>
                                <li><strong>Apple 日历:</strong> 打开日历应用 -> 文件 -> 新建日历订阅... -> 粘贴链接并点击"订阅"。</li>
                                <li><strong>Outlook 日历:</strong> 打开Outlook日历 -> 左侧导航栏中"添加日历" -> 选择"从网络订阅" -> 粘贴链接并点击"导入"。</li>
                            </ul>
                            <p>日历内容将自动更新。</p>
                        </div>
                    `;
                } catch (err) {
                    // 如果复制失败（例如非HTTPS环境或用户拒绝权限），则显示链接供手动复制
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <p>订阅链接：<br><code>${window.location.origin + data.calendarUrl}</code></p>
                            <p>请手动复制以上链接，并按照您日历应用的指引进行订阅。</p>
                            <ul>
                                <li><strong>Google 日历:</strong> 打开Google日历 -> 左侧"其他日历"旁边点击"+" -> 选择"通过网址" -> 粘贴链接并点击"添加日历"。</li>
                                <li><strong>Apple 日历:</strong> 打开日历应用 -> 文件 -> 新建日历订阅... -> 粘贴链接并点击"订阅"。</li>
                                <li><strong>Outlook 日历:</strong> 打开Outlook日历 -> 左侧导航栏中"添加日历" -> 选择"从网络订阅" -> 粘贴链接并点击"导入"。</li>
                            </ul>
                            <p>日历内容将自动更新。</p>
                        </div>
                    `;
                    console.error('复制到剪贴板失败:', err);
                }
                
            } catch (error) {
                console.error('订阅失败:', error);
                document.getElementById('subscribeResult').innerHTML = `
                    <div class="alert alert-danger">
                        订阅失败，请稍后重试
                    </div>
                `;
            }
        });

        // 页面加载时获取信息
        fetchLatestPriceInfo();
        fetchPriceInfo();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 